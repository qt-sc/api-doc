# 项目小结

18342041 赖培文



在这次项目中，我主要负责后端 Server 部分，关于数据库接口和服务接口的实现；



## 数据库接口

数据库接口用于和数据库交互，目录结构如下：

```
server
├── ...
database
|	├── api_article.go
|	├── api_reply.go
|	├── api_tag.go
|	├── api_user.go
|	├── database.go
|	└── init.go
└── ...
```

- `database.go` 定义数据库接口
- `init.go` 连接并初始化数据库
- `api_xxx.go` 对应 `user` 用户 、`article` 文章 、`reply` 评论和 `tag` 标签资源的 CRUD 操作的数据库实现



`database.go` 中定义数据库提供的接口，对资源的 CRUD 操作；当需要增加操作时，只需要在对应资源的 `api_xxx.go` 文件中增加需要的操作，然后在此处更新接口，这样就能向外提供相应的操作

```go
type DBServiceInterface interface {

	GetAllUser() ([]model.User, error)
	GetOneUser(string) (model.User, error)
	CreateUser(model.User) (bool, error)
	DeleteUser(int64) (bool, error)
	UpdateUser(model.User) (bool, error)

	GetAllArticle() ([]model.Article, error)
	GetArticleByUser(int64) ([]model.Article, error)
	GetArticleByTag(string) ([]model.Article, error)
	GetArticleByArticle(int64) (model.Article, error)
	CreateArticle(model.Article) (bool, error)
	DeleteArticle(int64) (bool, error)
	UpdateArticleLikeNum(int64, int64) (bool, error)
	UpdateArticleContent(int64, string) (bool, error)

	GetReply(int64) (model.Reply, error)
	GetReplyByArticle(int64) ([]model.Reply, error)
	CreateReply(model.Reply) (bool, error)
	UpdateReplyLikeNum(int64, int64) (bool, error)

	GetAllTag() ([]model.Tag, error)
	GetTagByArticle(int64) ([]model.Tag, error)
	CreateTag(model.Tag) (bool, error)
}

type DBService struct {}
```



`init.go` 根据预先设定的参数连接指定数据库，然后初始化数据库，建立相应的资源表

```go
func init(){
	var DBNAME = "mydb"
	var DBUSERNAME = "root"
	var DBPASSWORD = "root"
	var DBADDRESS = "localhost"
	var DBPORT = "3306"
	url := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=utf8", DBUSERNAME, DBPASSWORD, DBADDRESS, DBPORT, DBNAME)
	var err error
	db, err = gorm.Open("mysql", url)
	if err != nil {
		log.Println(err)
		return
	}

	db.SingularTable(true)
	createTable()

	return
}

func createTable() {

	if(!db.HasTable(&model.User{})) {
		db.Set("gorm:table_options", "ENGINE=InnoDB").CreateTable(&model.User{})
	}

	//...

	return
}
```



`api_xxx.go` 为对应资源的 CRUD 操作的数据库实现；以 `api_article.go` 为例，说明运用 gorm 对数据库进行 CRUD 操作

-  `Find(&records)` 获取所有记录

```go
//GetAllArticle 获取所有文章
func (dbservice *DBService) GetAllArticle() ([]model.Article, error) {
	var articlelist []model.Article
	if err := db.Table("article").Find(&articlelist).Error; err != nil {
		return articlelist, err
	}
	return articlelist, nil
}
```

- `Where("id = ?", id).First(&recode)` 结合where查询，获取首个符合条件记录
    - 当查询条件为主键时，可以使用 `First(&record, id)`

```go
//GetArticleByArticle 获取指定文章
func (dbservice *DBService) GetArticleByArticle(article_id int64) (model.Article, error) {
	var article model.Article
	if err := db.Table("article").Where("id = ?", article_id).First(&article).Error; err != nil {
		return article, err
	}
	return article, nil
}
```

- `Create(&record)` 创建记录

```go
//CreateArticle 创建文章
func (dbservice *DBService) CreateArticle(article model.Article) (bool, error) {
	if err := db.Table("article").Create(&article).Error; err != nil {
		return false, err
	}
	return true, nil

}
```

- `Delete(&record, id)` 根据主键删除记录

```go
//DeleteArticle 删除文章
func (dbservice *DBService) DeleteArticle(article_id int64) (bool, error) {

	if err := db.Table("article").Delete(&model.Article{}, article_id).Error; err != nil {
		return false, err
	}
	return true, nil

}
```

- `Model(&record).Update(...)` 更新记录指定字段

```go
//UpdateArticleContent 更新文章内容
func (dbservice *DBService) UpdateArticleContent(article_id int64, content string) (bool, error) {

	var article model.Article
	if err := db.Table("article").Where("id = ?", article_id).First(&article).Error; err != nil {
		return false, err
	}

	if err := db.Table("article").Model(&article).Update("Content", content).Error; err != nil {
		return false, err
	}
	return true, nil
}
```

- `Model(&master).Related(&slaves)` 根据主表记录获取从表记录

    由于 `user` 和 `article` 之间存在 `hasMany` 包含多个关系，一个用户可以有很多篇文章；先找到指定用户，再通过该用户获取相关联的所有文章

```go
//GetArticleByUser 获取用户所有文章
func (dbservice *DBService) GetArticleByUser(user_id int64) ([]model.Article, error) {
	var articlelist []model.Article

	var user model.User
	if err := db.Table("user").Where("id = ?", user_id).First(&user).Error; err != nil {
		return articlelist, err
	}

	if err := db.Model(&user).Related(&articlelist).Error; err != nil {
		return articlelist, err
	}
	return articlelist, nil
}
```

- `Model(&left).Related(&right, ForeignKey)` 用连接表获取记录

    由于 `article` 和 `tag` 之间存在 `many2many` 多对多的关系，一篇文章可以有多个标签，一个标签可以有多篇文章；在定义 `Article` 数据结构时，创建 `article_tags` 连接表

```go
type Article struct {
	//...
	Tags []Tag `json:"tags,omitempty" gorm:"tags;many2many:article_tags`
}
```

```go
//GetArticleByTag 获取标签所有文章
func (dbservice *DBService) GetArticleByTag(tag_name string) ([]model.Article, error) {
	var articlelist []model.Article

	var tag model.Tag
	if err := db.Table("tag").Where("name = ?", tag_name).First(&tag).Error; err != nil {
		return articlelist, err
	}

	if err := db.Model(&tag).Related(&articlelist, "Tags").Error; err != nil {
		return articlelist, err
	}
	return articlelist, nil
}
```



## 服务接口

API服务接口用于处理前端请求

```
server
├── ...
service
|	├── api_article.go
|	├── api_default.go
|	├── api_reply.go
|	├── api_tag.go
|	├── api_user.go
|	└── init.go
└── ...
```









